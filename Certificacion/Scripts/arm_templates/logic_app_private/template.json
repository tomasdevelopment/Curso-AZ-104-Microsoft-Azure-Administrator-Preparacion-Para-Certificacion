{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "logicAppName": { "type": "string" },
    "location": { "type": "string", "defaultValue": "[resourceGroup().location]" },

    "appServicePlanName": { "type": "string" },
    "sku": { "type": "string", "defaultValue": "WorkflowStandard" },
    "skuCode": { "type": "string", "defaultValue": "WS1" },

    "vnetName": { "type": "string" },
    "vnetResourceGroupName": { "type": "string" },
    "subnetName": { "type": "string" },

    "appInsightName": { "type": "string" },

    "contentStorageAccountResourceGroup": { "type": "string" },
    "contentStorageAccountName": { "type": "string" },
    "fileShareName": { "type": "string" },

    "use32BitWorkerProcess": { "type": "bool", "defaultValue": false },

    "enablePrivateEndpoint": { "type": "bool", "defaultValue": true },
    "privateEndpointName": { "type": "string", "defaultValue": "[concat(parameters('logicAppName'), '-pe')]" },
    "privateEndpointSubnetId": { "type": "string" },
    "privateDnsZoneId": { "type": "string", "defaultValue": "" },
    "privateEndpointResourceGroupName": { "type": "string", "defaultValue": "[parameters('vnetResourceGroupName')]" },

    "appResourceGroupName": { "type": "string", "defaultValue": "[resourceGroup().name]" },

    "createFileShare": { "type": "bool", "defaultValue": false }
  },
  "variables": {
    "planId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
    "subnetId": "[resourceId(parameters('vnetResourceGroupName'), 'Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName'))]",
    "vnetId": "[resourceId(parameters('vnetResourceGroupName'), 'Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2023-01-01",
      "name": "[parameters('appServicePlanName')]",
      "location": "[parameters('location')]",
      "sku": {
        "tier": "[parameters('sku')]",
        "name": "[parameters('skuCode')]"
      },
      "kind": "elastic",
      "properties": {
        "maximumElasticWorkerCount": 20
      }
    },

    {
      "condition": "[parameters('createFileShare')]",
      "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
      "apiVersion": "2023-01-01",
      "name": "[concat(parameters('contentStorageAccountName'), '/default/', toLower(parameters('fileShareName')))]",
      "location": "[parameters('location')]",
      "properties": {
        "shareQuota": 5120
      }
    },

    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2023-01-01",
      "name": "[parameters('logicAppName')]",
      "location": "[parameters('location')]",
      "kind": "functionapp,workflowapp",
      "identity": { "type": "SystemAssigned" },
      "dependsOn": [
        "[variables('planId')]"
      ],
      "properties": {
        "serverFarmId": "[variables('planId')]",
        "httpsOnly": true,
        "clientAffinityEnabled": false,
        "virtualNetworkSubnetId": "[variables('subnetId')]",
        "siteConfig": {
          "use32BitWorkerProcess": "[parameters('use32BitWorkerProcess')]",
          "alwaysOn": true,
          "ftpsState": "Disabled",
          "minTlsVersion": "1.2",
          "cors": {
            "allowedOrigins": [
              "https://afd.hosting.portal.azure.net",
              "https://afd.hosting-ms.portal.azure.net",
              "https://hosting.portal.azure.net",
              "https://ms.hosting.portal.azure.net",
              "https://ema-ms.hosting.portal.azure.net",
              "https://ema.hosting.portal.azure.net"
            ]
          },
          "appSettings": [
            { "name": "FUNCTIONS_EXTENSION_VERSION", "value": "~4" },
            { "name": "FUNCTIONS_WORKER_RUNTIME", "value": "dotnet" },

            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightName')), '2015-05-01').InstrumentationKey]"
            },
            {
              "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightName')), '2015-05-01').ConnectionString]"
            },

            {
              "name": "AzureWebJobsStorage",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('contentStorageAccountName'), ';AccountKey=', listKeys(resourceId(parameters('contentStorageAccountResourceGroup'), 'Microsoft.Storage/storageAccounts', parameters('contentStorageAccountName')), '2023-01-01').keys[0].value, ';EndpointSuffix=core.windows.net')]"
            },
            {
              "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('contentStorageAccountName'), ';AccountKey=', listKeys(resourceId(parameters('contentStorageAccountResourceGroup'), 'Microsoft.Storage/storageAccounts', parameters('contentStorageAccountName')), '2023-01-01').keys[0].value, ';EndpointSuffix=core.windows.net')]"
            },
            { "name": "WEBSITE_CONTENTSHARE", "value": "[toLower(parameters('fileShareName'))]" },

            { "name": "APP_KIND", "value": "workflowApp" },

            { "name": "WEBSITE_VNET_ROUTE_ALL", "value": "1" },
            { "name": "WEBSITE_CONTENTOVERVNET", "value": "1" },

            { "name": "AzureFunctionsJobHost__extensionBundle__id", "value": "Microsoft.Azure.Functions.ExtensionBundle.Workflows" },
            { "name": "AzureFunctionsJobHost__extensionBundle__version", "value": "[concat('[', '1.*, 2.0.0)')]" }
          ]
        }
      }
    },

    {
      "type": "Microsoft.Web/sites/networkconfig",
      "apiVersion": "2022-03-01",
      "name": "[concat(parameters('logicAppName'), '/virtualNetwork')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('logicAppName'))]"
      ],
      "properties": {
        "subnetResourceId": "[variables('subnetId')]",
        "swiftSupported": true
      }
    },

    {
      "condition": "[parameters('enablePrivateEndpoint')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2021-04-01",
      "name": "deployLogicAppPrivateEndpoint",
      "resourceGroup": "[parameters('privateEndpointResourceGroupName')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('logicAppName'))]"
      ],
      "properties": {
        "expressionEvaluationOptions": { "scope": "inner" },
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "logicAppName": { "type": "string" },
            "appResourceGroupName": { "type": "string" },
            "location": { "type": "string" },
            "privateEndpointName": { "type": "string" },
            "privateEndpointSubnetId": { "type": "string" },
            "privateDnsZoneId": { "type": "string" }
          },
          "resources": [
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[parameters('privateEndpointName')]",
              "location": "[parameters('location')]",
              "properties": {
                "subnet": { "id": "[parameters('privateEndpointSubnetId')]" },
                "privateLinkServiceConnections": [
                  {
                    "name": "logicapp-ples-conn",
                    "properties": {
                      "privateLinkServiceId": "[resourceId(subscription().subscriptionId, parameters('appResourceGroupName'), 'Microsoft.Web/sites', parameters('logicAppName'))]",
                      "groupIds": [ "sites" ],
                      "requestMessage": "Auto-approved by ARM"
                    }
                  }
                ]
              }
            },
            {
              "condition": "[not(empty(parameters('privateDnsZoneId')))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-05-01",
              "name": "[concat(parameters('privateEndpointName'), '/appsvc-dns')]",
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', parameters('privateEndpointName'))]"
              ],
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink",
                    "properties": { "privateDnsZoneId": "[parameters('privateDnsZoneId')]" }
                  }
                ]
              }
            }
          ]
        },
        "parameters": {
          "logicAppName": { "value": "[parameters('logicAppName')]" },
          "appResourceGroupName": { "value": "[parameters('appResourceGroupName')]" },
          "location": { "value": "[parameters('location')]" },
          "privateEndpointName": { "value": "[parameters('privateEndpointName')]" },
          "privateEndpointSubnetId": { "value": "[parameters('privateEndpointSubnetId')]" },
          "privateDnsZoneId": { "value": "[parameters('privateDnsZoneId')]" }
        }
      }
    }
  ],
  "outputs": {
    "logicAppResourceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Web/sites', parameters('logicAppName'))]"
    },
    "logicAppDefaultHostname": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Web/sites', parameters('logicAppName')), '2023-01-01').defaultHostName]"
    },
    "logicAppPrivateEndpointName": {
      "type": "string",
      "value": "[if(parameters('enablePrivateEndpoint'), parameters('privateEndpointName'), 'PE not created')]"
    }
  }
}
